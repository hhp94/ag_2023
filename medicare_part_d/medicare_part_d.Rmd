---
title: "Medicare Part D Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    css: css/ag_styles.css
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(shinyWidgets)
library(shinyFeedback)
library(shinyjs)
library(DT)

library(plotly)
library(data.table) # Requires dev version of data.table
library(ggplot2)
library(scales)
library(purrr)
library(dplyr)
```

```{r}
md <- fst::read_fst(here::here("data", "cleaned_medicare_part_d.fst"),
  as.data.table = TRUE
)

states <- readRDS(here::here("data", "states.rds"))

source(here::here("R", "dynamic_filter.R"))
source(here::here("R", "utils.R"))
```

Column {.sidebar}
-----------------------------------------------------------------------
```{r}
useShinyjs(rmd = TRUE)
useShinyFeedback()

awesomeCheckboxGroup(
  inputId = "agg_inp",
  label = "Aggregate By",
  choices = choice_masker(c("year", "state")),
  inline = TRUE,
  selected = choice_masker(c("year", "state"))
)

numericInput(
  inputId = "denom",
  "Per ? People",
  value = 1000000,
  min = 1, max = 1e7
)

awesomeCheckboxGroup(
  inputId = "year_inp",
  label = "Year",
  choices = 2016:2019,
  selected = 2016:2019
)

pickerInput(
  inputId = "state_inp",
  label = "State",
  choices = states$state,
  selected = states$state,
  options = list(
    `live-search` = TRUE,
    `actions-box` = TRUE,
    `selected-text-format` = "count > 3"
  ),
  multiple = TRUE
)
```

```{r}
wellPanel(
  titlePanel("Selected Drug"),
  renderValueBox(selected_drug())
)
```

```{r}
prettySwitch(
  inputId = "filter_toggle",
  label = "Advanced Filters"
)

conditionalPanel(
  condition = "input.filter_toggle == true",
  awesomeCheckboxGroup(
    inputId = "extra_filter",
    label = "Filter by",
    choices = choice_masker(extra_filter_choices),
    selected = NULL
  ),
  uiOutput("dynamic")
)

output$dynamic <-
  renderUI({
    map(input$extra_filter, \(x) {
      make_ui(filtered_tbl()[[x]], x, var_label_fns, n_digits = n_digits)
    })
  })
```

Column {data-width=350}
-----------------------------------------------------------------------

### Summary Table
```{r}
denominator <- reactive({
  req(is.numeric(input$denom), cancelOutput = TRUE)
  bet <- data.table::between(input$denom, 1, 1e7)
  
  feedbackWarning("denom", !bet, "Please select a number between 1 and 10,000,000")
  req(bet, cancelOutput = TRUE)
  
  input$denom
})

filtered_tbl <-
  reactive({
    processed_md <- (copy(md))
    processed_md[
      ,
      (var_for_agg) := lapply(.SD, \(x) {
        x * denominator()
      }),
      .SDcols = var_for_agg
    ][
      year %in% as.numeric(input$year_inp) &
        state %in% input$state_inp, 
    ][,
      lapply(.SD, sum, na.rm = TRUE),
      .SDcols = extra_filter_choices,
      by = c("Brnd_Name", "Gnrc_Name", input$agg_inp)
    ][]
  })

selected_rows <- reactive({
  c(list(rep(TRUE, times = nrow(filtered_tbl()))),
    map(input$extra_filter,
        \(x) {
          filter_var(filtered_tbl()[[x]], input[[x]])
        })) |>
    reduce(`&`)
})

dsplyd_tbl <- reactive({
  filtered_tbl()[selected_rows(), ]
})
```

```{r}
dsplyd_tbl_fmtd <- reactive({
  datatable(
    dsplyd_tbl(),
    colnames = var_label_fns_v(names(dsplyd_tbl())),
    selection = list(mode = 'single', selected = 1, target = 'row') ,
    rownames = FALSE
  ) |>
    formatRound("Tot_Drug_Cst", digits = n_digits) |>
    formatRound(c("Tot_Prscrbrs", "Tot_Clms", "Tot_Benes"), digits = n_digits)
})

output$main_tbl <- renderDataTable({
  dsplyd_tbl_fmtd()
})

dataTableOutput(outputId = "main_tbl")
```

```{r}
selected_drug <-
  reactive({
    req(
      input$main_tbl_rows_selected,
      !is.na(input$main_tbl_rows_selected),
      cancelOutput = TRUE
    )
    dsplyd_tbl()[input$main_tbl_rows_selected, Brnd_Name]
  })
```

### Chart B
```{r}
renderPrint(selected_rows())
```

Column {data-width=350}
-----------------------------------------------------------------------

### National Trend Overtime
```{r}
awesomeRadio(
  inputId = "viz_by_year",
  label = NULL,
  width = "100%",
  inline = TRUE,
  choices = choice_masker(var_for_agg),
  selected = "Tot_Drug_Cst"
)

plotly_overtime_df <- reactive({
  req(
    input$main_tbl_rows_selected,
    input$viz_by_year,
    input$year_inp,
    cancelOutput = TRUE
  )

  md[
    Brnd_Name %in% selected_drug() & year %in% as.numeric(input$year_inp),
    list(var1 = sum(var2 * denominator(), na.rm = TRUE)),
    by = c("Brnd_Name", "year"),
    env = list(var1 = "agg_sum",
               var2 = input$viz_by_year)
  ][order(year)]
})

plotly_overtime <- reactive({
  plotly_overtime_df() |>
    plot_ly(x = ~ year,
            y = ~ agg_sum) |>
    add_trace(type = "scatter", mode = "lines+markers") |>
    layout(yaxis = list(title = var_label_fns(input$viz_by_year)),
           margin = list(b = 50))
})

renderPlotly({
  plotly_overtime()
})
```

### Medicare part D data by State
```{r}
awesomeRadio(
  inputId = "viz_by_state",
  label = NULL,
  width = "100%",
  inline = TRUE,
  choices = set_names(var_for_agg, map_chr(var_for_agg, var_label_fns)),
  selected = "Tot_Drug_Cst"
)

plotly_chloropleth_df <- reactive({
  req(
    input$main_tbl_rows_selected,
    input$viz_by_state,
    input$state_inp,
    cancelOutput = TRUE
  )

  md[Brnd_Name %in% selected_drug() & state %in% input$state_inp,
     list(var1 = sum(var2)),
     by = c("Brnd_Name", "state"),
     env = list(var1 = var_label_fns(input$viz_by_state),
                var2 = input$viz_by_state)]
})

output$plotly_chloropleth <- renderPlotly(expr = {
  plotly_chloropleth_df() |>
    plot_geo(locationmode = "USA-states") |>
    add_trace(
      z = plotly_formula(input$viz_by_state),
      locations = ~state,
      color = plotly_formula(input$viz_by_state),
      colors = "Blues"
    ) |>
    layout(geo = list(
      scope = "usa",
      projection = list(type = "albers usa"),
      showlakes = TRUE,
      lakecolor = toRGB("white")
    ))
})

plotlyOutput(outputId = "plotly_chloropleth")
```

